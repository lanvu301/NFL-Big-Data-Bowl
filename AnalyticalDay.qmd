---
title: "Analytical Day LAN VU"
format: pdf
execute:
  echo: true
  warning: false
  message: false
---



```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  dev = "png",
  fig.align = "center"
)
knitr::opts_knit$set(stop_on_error = TRUE)

plays <- read.csv("plays.csv")

```

Step 0:

```{r}

library(tidyverse)
library(dplyr)
library(knitr)

# ---------------------------
# Summary Statistics
# ---------------------------
numeric_summary <- plays %>%
  summarise(
    Yards_Min  = min(yardsGained, na.rm = TRUE),
    Yards_Max  = max(yardsGained, na.rm = TRUE),
    Yards_Mean = mean(yardsGained, na.rm = TRUE),
    Yards_SD   = sd(yardsGained, na.rm = TRUE)
  )

kable(numeric_summary,
      caption = "Summary Statistics for Key Numeric Variables",
      digits = 2,
      booktabs = TRUE)

# ---------------------------
# Dataset Size (N)
# ---------------------------
n_plays <- nrow(plays)
cat("Total number of plays (N):", n_plays, "\n")

# ---------------------------
# Data Dictionary
# ---------------------------
data_dictionary <- tibble(
  Variable = c(
    "yardsGained", 
    "offenseFormation", 
    "coverage_group", 
    "quarter"
  ),
  Type = c(
    "Numeric",
    "Categorical",
    "Categorical",
    "Ordinal"
  ),
  Description = c(
    "Total yards gained on the play",
    "Offensive formation used on the play",
    "Defensive pass coverage category (collapsed)",
    "Quarter of the game (1–5, where 5 = overtime)"
  ),
  Range_or_Levels = c(
    paste(range(plays$yardsGained, na.rm = TRUE), collapse = " to "),
    paste(unique(plays$offenseFormation), collapse = ", "),
    paste(unique(plays$coverage_group), collapse = ", "),
    paste(range(plays$quarter, na.rm = TRUE), collapse = " to ")
  )
)

kable(data_dictionary,
      caption = "Data Dictionary for Key Variables",
      booktabs = TRUE)

# ---------------------------
# Coverage Recoding Table
# ---------------------------
coverage_recode_table <- tibble(
  Original_Label = c(
    "Cover-3", "Cover-3 Cloud Left", "Cover-3 Cloud Right",
    "Cover-1", "Cover-1 Double",
    "Cover 6-Left", "Cover-6 Right",
    "Bracket", "Prevent", "Goal Line"
  ),
  Recoded_Group = c(
    rep("Cover_3", 3),
    rep("Cover_1", 2),
    rep("Cover_6", 2),
    rep("Other_Rare", 3)
  )
)

kable(coverage_recode_table,
      caption = "Defensive Coverage Recoding Scheme",
      booktabs = TRUE)

```

Step 1: Clean data

```{r}
colSums(is.na(plays))
```

```{r}
handle_missing_values <- function(df, threshold = 0.7) {
  # Step 1: Calculate percentage of missing values per column
  missing_percentage <- colMeans(is.na(df))
  
  # Step 2: Drop columns exceeding threshold
  cols_to_drop <- names(missing_percentage[missing_percentage > threshold])
  df <- df[ , !(names(df) %in% cols_to_drop)]
  message("Dropped columns with more than ", threshold * 100, "% missing values: ", 
          paste(cols_to_drop, collapse = ", "))
  
  # Step 3: Separate numeric and categorical columns
  numeric_cols <- sapply(df, is.numeric)
  categorical_cols <- !numeric_cols
  
  # Step 4: Impute missing values
  # Numeric: replace NA with mean
  for (col in names(df)[numeric_cols]) {
    df[[col]][is.na(df[[col]])] <- mean(df[[col]], na.rm = TRUE)
  }
  
  # Categorical: replace NA with mode (most frequent value)
  mode_value <- function(x) {
    ux <- unique(na.omit(x))
    ux[which.max(tabulate(match(x, ux)))]
  }
  for (col in names(df)[categorical_cols]) {
    df[[col]][is.na(df[[col]])] <- mode_value(df[[col]])
  }
  
  # Step 5: Verify cleanup
  remaining_missing <- colSums(is.na(df))
  message("\nRemaining missing values after handling:\n")
  print(remaining_missing)
  
  return(df)
}

clean_plays<-handle_missing_values(plays)
```

STEP 2: Relationship BETWEEN OFFENSE FORMATION AND YARDGAINED A: Basic distribtuion of YardGained

```{r}
library(ggplot2)

ggplot(clean_plays, aes(x = yardsGained)) +
  geom_histogram(binwidth = 2, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Yards Gained",
       x = "Yards Gained",
       y = "Frequency") +
  theme_minimal(base_size = 14)

```

Barplot of OffenseFormation

```{r}
ggplot(clean_plays, aes(x = offenseFormation)) +
  geom_bar(fill = "darkorange", color = "black", alpha = 0.8) +
  labs(title = "Frequency of Offensive Formations",
       x = "Offensive Formation",
       y = "Count") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Bar plot of distribution of passCoverage

```{r}
ggplot(clean_plays, aes(x = pff_passCoverage)) +
  geom_bar(fill = "seagreen3", color = "black", alpha = 0.8) +
  labs(title = "Distribution of Pass Coverage Types",
       x = "PFF Pass Coverage",
       y = "Count") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}


formation_success <- clean_plays %>%
  group_by(offenseFormation) %>%
  summarise(Average_Yards_Gained = mean(yardsGained, na.rm = TRUE)) %>%
  arrange(desc(Average_Yards_Gained))

# Step 2: Print results in styled console output
cat("\nAverage Yards Gained by Formation:\n")
cat(strrep("=", 50), "\n")
cat(sprintf("%-25s %-25s\n", "Formation", "Average Yards Gained"))
cat(strrep("-", 50), "\n")

for (i in seq_len(nrow(formation_success))) {
  formation <- formation_success$offenseFormation[i]
  yards <- formation_success$Average_Yards_Gained[i]
  
  
  cat(sprintf("%-25s %-25.2f\n", formation, yards))
}

# Step 3: Visualization (bar chart)
ggplot(formation_success, aes(x = reorder(offenseFormation, Average_Yards_Gained),
                              y = Average_Yards_Gained,
                              fill = Average_Yards_Gained>0))+
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("TRUE" = "seagreen3", "FALSE" = "firebrick2")) +
  coord_flip() +
  labs(
    title = "Average Yards Gained by Offensive Formation",
    x = "Offensive Formation",
    y = "Average Yards Gained"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")



```

Next is OffenseFormation by PassCoverage

Let's group the pass_coverage to smaller group

```{r}
clean_plays$coverage_group <- clean_plays$pff_passCoverage

clean_plays$coverage_group <- forcats::fct_collapse(
  clean_plays$coverage_group,
  Cover_3 = c("Cover-3", "Cover-3 Cloud Left", "Cover-3 Cloud Right",
              "Cover-3 Seam", "Cover-3 Double Cloud"),
  Cover_6 = c("Cover 6-Left", "Cover-6 Right"),
  Cover_1 = c("Cover-1", "Cover-1 Double"),
  Other_Rare = c("Bracket", "Miscellaneous", "Prevent", "2-Man", "Goal Line")
)
```

See the distribution after grouping

```{r}
ggplot(clean_plays, aes(x = coverage_group)) +
  geom_bar(fill = "seagreen3", color = "black") +
  geom_text(
    stat = "count",
    aes(label = paste0(round((..count..) / sum(..count..) * 100, 1), "%")),
    vjust = -0.1,
size = 4
  ) +
  labs(
    title = "Distribution of Pass Coverage Types",
    x = "PFF Pass Coverage",
    y = "Count"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(clean_plays, aes(x = offenseFormation)) +
  geom_bar(fill = "seagreen3", color = "black") +
  geom_text(
    stat = "count",
    aes(label = paste0(round((..count..) / sum(..count..) * 100, 1), "%")),
    vjust = -0.1,
    size = 4
  ) +
  labs(
    title = "Distribution of Offense Formation",
    x = "Offense Formation",
    y = "Count"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Now run the plot

```{r}
library(dplyr)

yards_by_formation_cov <- clean_plays %>%
  group_by(offenseFormation, coverage_group) %>%
  summarise(
    avg_yards = mean(yardsGained, na.rm = TRUE),
    play_count = n(),
    .groups = "drop"
  )

```

Visualize it

```{r}
library(ggplot2)

ggplot(yards_by_formation_cov, 
       aes(x = offenseFormation, y = avg_yards, fill = coverage_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), color = "gray30") +
  scale_fill_manual(
    values = c(
      "Cover-0"   = "#FFD23F",  # golden yellow
      "Cover_1"   = "#FFB703",  # orange-yellow
      "Cover-2"   = "#90CAF9",  # light blue
      "Cover_3"   = "#2196F3",  # mid blue
      "Cover_6"   = "#1565C0",  # deep blue
      "Quarters"  = "#6A1B9A",  # purple accent
      "Red Zone"  = "#E63946",  # red
      "Other_Rare"= "#8D99AE"   # neutral gray
    )
  ) +
  labs(
    title = "Average Yards Gained by Formation and Pass Coverage",
    x = "Offensive Formation",
    y = "Average Yards Gained",
    fill = "Pass Coverage Type"
  )+
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```

```{r}
# Group 1: First four coverage types
cover_group1 <- c("Other_Rare", "Cover-0", "Cover_1", "Cover-2")
# Group 2: Remaining four coverage types
cover_group2 <- c("Cover_3", "Cover_6", "Quarters", "Red Zone")

# Split data
clean_plays_1 <- subset(clean_plays, coverage_group %in% cover_group1)
clean_plays_2 <- subset(clean_plays, coverage_group %in% cover_group2)


```

OK NOW OFFENSIVE FORMATION IN DIFFERENT QUARTER

Compute the yardGain by formation

```{r}
library(dplyr)

# Summarize average yards by formation and quarter
yards_by_quarter <- clean_plays %>%
  group_by(offenseFormation, quarter) %>%
  summarise(
    avg_yards = mean(yardsGained, na.rm = TRUE),
    play_count = n(),
    .groups = "drop"
  )

# Print results
cat("\nAverage Yards Gained by Formation and Quarter:\n")
cat(strrep("=", 60), "\n")
cat(sprintf("%-15s %-10s %-20s %-10s\n", 
            "Formation", "Quarter", "Average Yards", "Plays"))
cat(strrep("-", 60), "\n")

for (i in seq_len(nrow(yards_by_quarter))) {
  formation <- yards_by_quarter$offenseFormation[i]
  quarter <- yards_by_quarter$quarter[i]
  yards <- yards_by_quarter$avg_yards[i]
  count <- yards_by_quarter$play_count[i]
  
  cat(sprintf("%-15s %-10s %-20.2f %-10d\n", formation, quarter, yards, count))
}


```

GGPlot

```{r}
library(ggplot2)

ggplot(yards_by_quarter, 
       aes(x = offenseFormation, y = avg_yards, fill = factor(quarter))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), color = "gray30") +
  scale_fill_manual(
    values = c(
      "1" = "#FFB703",  # orange-yellow
      "2" = "#90CAF9",  # light blue
      "3" = "#2196F3",  # mid blue
      "4" = "#1565C0",   # deep blue
      "5" = "#8D99AE"   # gray-blue for OT
    )
  ) +
  labs(
    title = "Average Yards Gained by Formation and Quarter",
    x = "Offensive Formation",
    y = "Average Yards Gained",
    fill = "Quarter"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )

```

CONDUCT AN ANOVA TEST

```{r}
# Fit model with interaction term
model_interaction <- lm(yardsGained ~ offenseFormation *coverage_group , data = clean_plays)

# Show summary
summary(model_interaction)

```

```{r}
anova(model_interaction)
```

GGPlot INteraction plot

```{r}
library(ggplot2)
library(dplyr)

interaction_summary <- clean_plays %>%
  group_by(offenseFormation, coverage_group) %>%
  summarise(mean_yards = mean(yardsGained, na.rm = TRUE))

ggplot(interaction_summary,
       aes(x = coverage_group, y = mean_yards, color = offenseFormation, group = offenseFormation)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2) +
  labs(
    title = "Interaction of Offensive Formation and Pass Coverage on Yards Gained",
    x = "Pass Coverage Type",
    y = "Average Yards Gained",
    color = "Offensive Formation"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

library(emmeans)

# Get estimated marginal means for each combination
emm <- emmeans(model_interaction, ~ offenseFormation | coverage_group)

# Compare formations within each coverage
pairs(emm, adjust = "fdr")


library(emmeans)

emm <- emmeans(model_interaction, ~ offenseFormation * coverage_group)

emm_df <- as.data.frame(emm)

ggplot(emm_df, aes(x = coverage_group, y = emmean, 
                   color = offenseFormation, group = offenseFormation)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), 
                width = 0.2, alpha = 0.4) +
  labs(
    title = "Interaction Between Formation and Coverage Type",
    x = "Defensive Coverage",
    y = "Estimated Yards Gained",
    color = "Offensive Formation"
  ) +
  theme_classic(base_size = 14) +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )



```

Match-up frequency

```{r}

formation_coverage_counts <- clean_plays %>%
  filter(!is.na(offenseFormation), !is.na(coverage_group)) %>%
  count(offenseFormation, coverage_group) %>%
  arrange(desc(n))


formation_coverage_pct <- clean_plays %>%
  filter(!is.na(offenseFormation), !is.na(coverage_group)) %>%
  count(offenseFormation, coverage_group) %>%
  group_by(offenseFormation) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ungroup()


ggplot(formation_coverage_pct, aes(x = coverage_group, y = offenseFormation, fill = pct)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(round(pct, 1), "%")), color = "black", size = 4) +
  scale_fill_gradient(low = "lightyellow", high = "seagreen4") +
  labs(
    title = "Distribution of Pass Coverages by Offensive Formation",
    x = "Pass Coverage Type",
    y = "Offensive Formation",
    fill = "Percentage of Plays"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )


```

Investigate the 4th quarter

```{r}
clean_plays_quarter <- clean_plays %>%
  mutate(game_phase = case_when(
    quarter %in% 1:3 ~ "Early (Q1–Q3)",
    quarter %in% 4:5 ~ "Late / Overtime",
    TRUE ~ "Unknown"
  ))


model_full_4<- lm(yardsGained ~ offenseFormation * coverage_group+game_phase, data = clean_plays_quarter)
summary(model_full_4)
```

```{r}

library(dplyr)
formation_phase_counts <- clean_plays_quarter %>%
  count(game_phase, offenseFormation) %>%
  group_by(game_phase) %>%
  mutate(pct = n / sum(n) * 100)




# Exclude JUMBO from both groups because it only appear in specific situation
clean_plays_1 <- subset(
  clean_plays_quarter,
  coverage_group %in% cover_group1 & offenseFormation != "JUMBO"
)

clean_plays_2 <- subset(
  clean_plays_quarter,
  coverage_group %in% cover_group2 & offenseFormation != "JUMBO"
)


```

```{r}
clean_plays_quarter %>%
  filter(game_phase == "Late / Overtime") %>%  # filter only Cover-2 plays
  group_by(game_phase,possessionTeam
           ) %>%
  summarise(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    sd_yards   = sd(yardsGained, na.rm = TRUE),
    n          = n()
  ) %>%
  arrange(desc(mean_yards))
```

```{r}
```

Something else with 3 way interaction

```{r}
library(ggplot2)
library(dplyr)
library(patchwork) 

# for multi-panel layout
clean_plays_3way <- clean_plays_quarter %>%
  filter(!is.na(offenseFormation), !is.na(coverage_group), !is.na(game_phase)) %>%
  mutate(
    game_phase = factor(game_phase, levels = c("Early (Q1–Q3)", "Late / Overtime")),
    offenseFormation = factor(offenseFormation),
    coverage_group = factor(coverage_group)
  )

#Plot 1 
p1 <- ggplot(clean_plays_quarter, aes(x = offenseFormation, y = yardsGained, fill = game_phase)) +
  geom_boxplot(outlier.alpha = 0.25) +
  coord_cartesian(ylim = c(-10, 30)) +
  labs(
    title = "Yards Gained by Formation & Game Phase",
    x = "Offensive Formation", y = "Yards Gained"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )

formation_phase_counts <- clean_plays_quarter %>%
  count(game_phase, offenseFormation) %>%
  group_by(game_phase) %>%
  mutate(pct = n / sum(n) * 100)

defense_phase_counts <- clean_plays_quarter %>%
  count(game_phase, coverage_group) %>%
  group_by(game_phase) %>%
  mutate(pct = n / sum(n) * 100)

p2 <- ggplot(formation_phase_counts, 
             aes(y = offenseFormation, x = pct, fill = game_phase)) +
  geom_bar(stat = "identity", 
           position = position_dodge(width = 0.8), 
           color = "black") +
  geom_text(
    aes(label = paste0(round(pct, 1), "%")),
    position = position_dodge(width = 0.8),
    hjust = 1.05,          # move inside the bar
    color = "black",       # white text contrasts with fill
    size = 3.5
  ) +
  scale_fill_manual(values = c(
    "Early (Q1–Q3)" = "#FFD54F",
    "Late / Overtime" = "#6D4C41"
  )) +
  labs(
    title = "Formation Usage by Game Phase",
    x = "Percentage of Plays",
    y = "Offensive Formation"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )




#PCT for defense

p_defense <- ggplot(defense_phase_counts, 
                    aes(y = coverage_group, x = pct, fill = game_phase)) +
  geom_bar(stat = "identity", 
           position = position_dodge(width = 0.8), 
           color = "black") +
  geom_text(
    aes(label = paste0(round(pct, 1), "%")),
    position = position_dodge(width = 0.8),
    hjust = -0.1,
    size = 3.5
  ) +
  scale_fill_manual(values = c(
    "Early (Q1–Q3)" = "#FFD54F",   # KSU gold
    "Late / Overtime" = "#6D4C41"  # dark bronze/brown contrast
  )) +
  labs(
    title = "Defensive Coverage Usage by Game Phase",
    x = "Percentage of Plays",
    y = "Coverage Type"
  ) +
  coord_cartesian(xlim = c(0, max(defense_phase_counts$pct) * 1.15)) + # padding for labels
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    axis.title = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )

formation_coverage_pct <- clean_plays %>%
  count(offenseFormation, coverage_group) %>%
  group_by(offenseFormation) %>%
  mutate(pct = n / sum(n) * 100)

p3 <- ggplot(formation_coverage_pct, aes(x = coverage_group, y = offenseFormation, fill = pct)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(round(pct, 1), "%")), size = 4) +
  scale_fill_gradient(low = "lightyellow", high = "seagreen4") +
  labs(
    title = "Coverage Type Distribution by Formation",
    x = "Pass Coverage Type", y = "Offensive Formation", fill = "% of Plays"
  ) +
  theme_minimal(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p1
p2
p3
```

INVESTIGATE JUMBO AND WILDCAT

```{r}
library(dplyr)

clean_plays_quarter %>%
  filter(offenseFormation %in% c("JUMBO", "WILDCAT")) %>%
  summarise(
    avg_yardsToGo = mean(yardsToGo, na.rm = TRUE),
    median_yardsToGo = median(yardsToGo, na.rm = TRUE),
    avg_yardline = mean(absoluteYardlineNumber, na.rm = TRUE),
    median_yardline = median(absoluteYardlineNumber, na.rm = TRUE),
    mean_yardsGained = mean(yardsGained, na.rm = TRUE),
    n = n()
  )

```

MOVE IT UP A LEVEL

```{r}
library(dplyr)

clean_plays_quarter_formation <- clean_plays_quarter %>%
  mutate(formation_group = case_when(
    offenseFormation %in% c("SHOTGUN", "SINGLEBACK", "PISTOL") ~ "Standard",
    offenseFormation %in% c("EMPTY", "I_FORM") ~ "Contextual",
    offenseFormation %in% c("JUMBO", "WILDCAT") ~ "Situational",
    TRUE ~ "Other"   # catch any undefined or rare formations
  ))
table(clean_plays_quarter_formation$formation_group)

#
clean_plays_quarter_formation %>%
  group_by(formation_group, offenseFormation) %>%
  summarise(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    sd_yards = sd(yardsGained, na.rm = TRUE),
    n = n()
  ) %>%
  arrange(formation_group, desc(mean_yards))




model_phase <- aov(yardsGained ~ formation_group * game_phase*coverage_group, 
                   data = clean_plays_quarter_formation)
summary(model_phase)

lm_model <- lm(
  yardsGained ~ offenseFormation*coverage_group+game_phase,
  data = clean_plays_quarter_formation
)
summary(lm_model)


```

Group WILDCAT AND JUMBO TOGETHER

```{r}
clean_plays_quarter_formation <- clean_plays_quarter_formation %>%
  mutate(formation_refined = case_when(
    offenseFormation %in% c("JUMBO", "WILDCAT") ~ "Situational",
    TRUE ~ offenseFormation
  ))

#Now draw some plot


#Plot 1 
ggplot(clean_plays_quarter_formation, aes(x = formation_refined, y = yardsGained, fill = game_phase)) +
  geom_boxplot(outlier.alpha = 0.25) +
  coord_cartesian(ylim = c(-10, 30)) +
  labs(
    title = "Yards Gained by Formation & Game Phase",
    x = "Offensive Formation", y = "Yards Gained"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )

formation_phase_counts <- clean_plays_quarter_formation %>%
  count(game_phase, formation_refined) %>%
  group_by(game_phase) %>%
  mutate(pct = n / sum(n) * 100)

#Plot 2
 p1<-ggplot(formation_phase_counts, aes(x = formation_refined, y = pct, fill = game_phase)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
   geom_text(
    aes(label = paste0(round(pct, 1), "%")),     # show percentages with one decimal
    position = position_dodge(width = 0.9),      # align text with each bar group
    vjust = -0.4,                                # vertical adjustment above bar
    size = 3.5                                   # text size
  ) +
  labs(
    title = "Formation Usage by Game Phase",
    x = "Offensive Formation", y = "Percentage of Plays"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )


formation_coverage_pct <- clean_plays_quarter_formation %>%
  count(formation_refined, coverage_group) %>%
  group_by(formation_refined) %>%
  mutate(pct = n / sum(n) * 100)

 ggplot(formation_coverage_pct, aes(x = coverage_group, y = formation_refined, fill = pct)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(round(pct, 1), "%")), size = 4) +
  scale_fill_gradient(low = "lightyellow", high = "seagreen4") +
  labs(
    title = "Coverage Type Distribution by Formation",
    x = "Pass Coverage Type", y = "Offensive Formation", fill = "% of Plays"
  ) +
  theme_minimal(base_size = 16) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



clean_plays_f1 <- subset(
  clean_plays_quarter_formation,
  coverage_group %in% cover_group1)

clean_plays_2 <- subset(
  clean_plays_quarter,
  coverage_group %in% cover_group2)



```

```{r}
library(dplyr)

cover2_summary <- clean_plays_quarter_formation %>%
  filter(coverage_group == "Cover-2") %>%
  group_by(offenseFormation) %>%
  summarise(
    n = n(),
    mean_yards = mean(yardsGained, na.rm = TRUE),
    median_yards = median(yardsGained, na.rm = TRUE),
    sd_yards = sd(yardsGained, na.rm = TRUE)
  ) %>%
  arrange(desc(mean_yards))

cover2_summary

```

```{r}
library(ggsci)
p_box <- ggplot(clean_plays_quarter_formation,
                aes(x = offenseFormation, y = yardsGained, fill = coverage_group)) +
  geom_boxplot(outlier.alpha = 0.2, width = 0.7, color = "gray30") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  stat_summary(fun = median, geom = "text",
               aes(label = round(..y.., 1)), size = 3, vjust = -0.6, color = "black") +
  facet_wrap(~ game_phase, ncol = 2) +
  scale_fill_npg(name = "Coverage Type") +
  coord_cartesian(ylim = c(-15, 35)) +
  labs(
    title = "Distribution of Yards Gained by Formation and Coverage",
    subtitle = "Faceted by Game Phase (Early vs Late)",
    x = "Offensive Formation",
    y = "Yards Gained"
  ) +
  theme_minimal(base_size = 18) +
  theme(
    panel.grid.major.x = element_blank(),
    strip.text = element_text(face = "bold", size = 16),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 13),
    plot.title = element_text(size = 22, face = "bold", hjust = 0.5),
    legend.position = "bottom"
  )


p_interact <- ggplot(clean_plays_quarter_formation,
                     aes(x = coverage_group, y = yardsGained,
                         color = offenseFormation, group = offenseFormation)) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.2) +
  stat_summary(fun = mean, geom = "point", size = 3) +
  facet_wrap(~ game_phase, ncol = 2) +
  scale_color_manual(values = c(
  "#E6B800",  # rich gold 
  "#FF8F00",  # dark amber 
  "#D84315",  # burnt orange 
  "#9C27B0",  # royal violet 
  "#8D6E63",  # warm taupe 
  "#6D4C41",  # dark brownish-gray
  "#455A64"   # cool gray-blue 
  )) +
  labs(
    title = "Interaction Between Formation and Coverage",
    subtitle = "Lines represent mean yards gained across game phases",
    x = "Coverage Type", y = "Mean Yards Gained", color = "Formation"
  ) +
  theme_minimal(base_size = 18) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


emm <- emmeans(lm_model, ~ offenseFormation * coverage_group)
emm_df <- as.data.frame(emm)

ggplot(emm_df, aes(coverage_group, emmean, color = offenseFormation, group = offenseFormation)) +
  geom_line(linewidth = 1.3) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.1)



p_pred <- ggplot(emm_df,
                 aes(x = coverage_group, y = emmean,
                     color = offenseFormation, group = offenseFormation)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2.2) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.15, alpha = 0.6) +
  labs(title = "Model-Predicted Interaction",
       subtitle = "Adjusted means with 95% CI (from LM)",
       x = "Coverage Type", y = "Estimated Yards Gained",
       color = "Formation") +
  scale_color_manual(values = c(
    "#E6B800", "#FF8F00", "#D84315", "#9C27B0",
    "#8D6E63", "#6D4C41", "#455A64"
  )) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))


p_raw <- ggplot(clean_plays_quarter_formation,
                aes(x = coverage_group, y = yardsGained,
                    color = offenseFormation, group = offenseFormation)) +
  stat_summary(fun = mean, geom = "line", linewidth = 1.1) +
  stat_summary(fun = mean, geom = "point", size = 2) +
  labs(title = "Observed Interaction",
       subtitle = "Raw mean yards gained by formation and coverage",
       x = "Coverage Type", y = "Mean Yards Gained") +
  scale_color_manual(values = c(
    "#E6B800", "#FF8F00", "#D84315", "#9C27B0",
    "#8D6E63", "#6D4C41", "#455A64"
  )) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))


```

Summarize the model for poster

```{r}
library(broom)
library(dplyr)

# main model
lm_model <- lm(yardsGained ~ offenseFormation * coverage_group + game_phase,
               data = clean_plays_quarter_formation)

# tidy summary table
model_summary <- broom::tidy(lm_model) %>%
  mutate(
    term = gsub("offenseFormation", "Formation: ", term),
    term = gsub("coverage_group", "Coverage: ", term),
    term = gsub("game_phase", "Phase: ", term),
    significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ ".",
      TRUE            ~ ""
    )
  ) %>%
  select(Term = term,
         Estimate = estimate,
         `Std. Error` = std.error,
         `t value` = statistic,
         `p value` = p.value,
         significance)

# view top 10 rows
head(model_summary, 10)
sig_effects <- model_summary %>%
  filter(`p value` < 0.05)



```

```{r}
library(dplyr)
library(knitr)
library(lmtest)
library(sandwich)

# Recompute OLS and HC3 safely inside this chunk
ols <- summary(model_interaction)$coefficients
rob <- coeftest(model_interaction, vcov = vcovHC(model_interaction, type = "HC3"))

# Build unified table
combined <- data.frame(
  Term = rownames(ols),
  Estimate = ols[, 1],
  Std.Error.OLS = ols[, 2],
  p.value.OLS = ols[, 4],
  Std.Error.HC3 = rob[, 2],
  p.value.HC3 = rob[, 4]
)

# Keep only predictors significant under HC3
sig_table <- combined %>%
  filter(p.value.HC3 < 0.05) %>%
  mutate(
    significance = case_when(
      p.value.HC3 < 0.001 ~ "***",
      p.value.HC3 < 0.01  ~ "**",
      p.value.HC3 < 0.05  ~ "*"
    ),
    Estimate = round(Estimate, 3),
    Std.Error.OLS = round(Std.Error.OLS, 3),
    p.value.OLS = round(p.value.OLS, 4),
    Std.Error.HC3 = round(Std.Error.HC3, 3),
    p.value.HC3 = round(p.value.HC3, 4)
  )

# Final PDF-safe table
kable(
  sig_table,
  caption = "Significant Effects Before and After HC3 Robust Correction",
  booktabs = TRUE,
  align = "c"
)



```

Create table to see the raw data

```{r}
clean_plays_quarter %>%
  group_by(offenseFormation, coverage_group) %>%
  summarise(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    sd_yards   = sd(yardsGained, na.rm = TRUE),
    n          = n(),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_yards))

```

format it and create a heatmap

```{r}

library(dplyr)
library(knitr)
library(ggplot2)

# Build summary table (same computation as before)
summary_table <- clean_plays_quarter %>%
  group_by(game_phase, offenseFormation, coverage_group) %>%
  summarise(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    sd_yards   = sd(yardsGained, na.rm = TRUE),
    n          = n(),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_yards)) %>%
  mutate(
    mean_yards = round(mean_yards, 2),
    sd_yards = round(sd_yards, 2)
  )

# ✅ PDF-SAFE TABLE (NO HTML)
kable(
  head(summary_table, 10),
  caption = "Average Yards Gained by Formation and Coverage",
  booktabs = TRUE,
  align = "c"
)

# ✅ PDF-SAFE HEATMAP
ggplot(summary_table, 
       aes(x = coverage_group, y = offenseFormation, fill = mean_yards)) +
  geom_tile(color = "white", linewidth = 0.4) +
  geom_text(aes(label = round(mean_yards, 1)), size = 4, color = "black") +
  facet_wrap(~ game_phase) +
  scale_fill_gradient(
    low = "white",
    high = "darkgreen",
    name = "Mean Yards"
  ) +
  labs(
    title = "Average Yards Gained by Formation and Coverage",
    subtitle = "Faceted by Game Phase (Early vs. Late)",
    x = "Defensive Coverage",
    y = "Offensive Formation"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )


```

Group the 2 freq table for formation and coverage

```{r}
p_form <- ggplot(formation_phase_counts, 
                 aes(y = offenseFormation, x = pct, fill = game_phase)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
  geom_text(aes(label = paste0(round(pct, 1), "%")),
            position = position_dodge(width = 0.8),
            hjust = -0.1, size = 3) +
  scale_fill_manual(values = c(
    "Early (Q1–Q3)" = "#FFD54F",    # KSU gold
    "Late / Overtime" = "#6D4C41"   # dark bronze/brown
  )) +
  labs(
    title = "Formation Usage by Game Phase",
    x = "Percentage of Plays", y = NULL
  ) +
  coord_cartesian(xlim = c(0, max(formation_phase_counts$pct) * 1.2)) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
p_def <- ggplot(defense_phase_counts, 
                aes(y = coverage_group, x = pct, fill = game_phase)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), color = "black") +
  geom_text(aes(label = paste0(round(pct, 1), "%")),
            position = position_dodge(width = 0.8),
            hjust = -0.1, size = 3) +
  scale_fill_manual(values = c(
    "Early (Q1–Q3)" = "#FFD54F",
    "Late / Overtime" = "#6D4C41"
  )) +
  labs(
    title = "Defensive Coverage Usage by Game Phase",
    x = "Percentage of Plays", y = NULL
  ) +
  coord_cartesian(xlim = c(0, max(defense_phase_counts$pct) * 1.2)) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(size = 8),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )

library(patchwork)
p_combine1<-p_form + p_def + plot_layout(ncol = 2, widths = c(1, 1))

```

Re-state the model

```{r}
# 1. FIT THE MODEL
model_interaction <- lm(yardsGained ~ offenseFormation * coverage_group+game_phase,
                        data = clean_plays_quarter_formation)
```

#THIS PART IS FOR ASSUMPTION TESTING#

```{r}
#Normality
library(nortest)
ad.test(residuals(model_interaction))
hist(residuals(model_interaction))
plot(model_interaction, which = 2)
```

```{r}
library(lmtest)

library(sandwich)
plot(model_interaction, which = 3)
bptest(model_interaction)
plot(model_interaction, which = 1)


coeftest(model_interaction,
         vcov = vcovHC(model_interaction, type = "HC3"))


```

```{r}
library(car)
library(knitr)
library(olsrr)
model_main <- lm(yardsGained ~ offenseFormation + coverage_group+game_phase,
                 data = clean_plays_quarter_formation)

vif_table <- vif(model_main)

# Convert to data frame for kable
vif_df <- as.data.frame(vif_table)

# Add row names as a column
vif_df$Predictor <- rownames(vif_df)
rownames(vif_df) <- NULL

# Reorder columns
vif_df <- vif_df[, c("Predictor", "GVIF", "Df", "GVIF^(1/(2*Df))")]

# Print clean table
kable(
  vif_df,
  caption = "Multicollinearity Diagnostics (GVIF Results)",
  digits = 6
)





```

```{r}
library(sandwich)
library(lmtest)

# OLS coefficients
ols <- summary(model_interaction)$coefficients

# HC3 robust coefficients
rob <- coeftest(model_interaction, vcov = vcovHC(model_interaction, type = "HC3"))
```

```{r}

library(dplyr)
library(gt)

# Get OLS + HC3 results
ols <- summary(model_interaction)$coefficients
rob <- coeftest(model_interaction, vcov = vcovHC(model_interaction, type = "HC3"))

# Build unified table
combined <- data.frame(
  Term = rownames(ols),
  Estimate = ols[, 1],
  `Std.Error.OLS` = ols[, 2],
  `p.value.OLS` = ols[, 4],
  `Std.Error.HC3` = rob[, 2],
  `p.value.HC3` = rob[, 4]
)

# Filter only predictors significant under HC3
sig_table <- combined %>%
  filter(`p.value.HC3` < 0.05) %>%
  mutate(
    significance = case_when(
      `p.value.HC3` < 0.001 ~ "***",
      `p.value.HC3` < 0.01 ~ "**",
      `p.value.HC3` < 0.05 ~ "*"
    )
  )


sig_table <- sig_table %>%
  rename(
    `Std. Error (OLS)` = Std.Error.OLS,
    `p value (OLS)` = p.value.OLS,
    `Std. Error (HC3)` = Std.Error.HC3,
    `p value (HC3)` = p.value.HC3
  )


sig_table %>%
  gt() %>%
  tab_header(title = "Significant Effects Before and After HC3 Robust Correction") %>%
  
  # Yellow header row
  tab_style(
    style = list(
      cell_fill(color = "#FFD54F"),
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  ) %>%
  
  # Round numeric columns
  fmt_number(
    columns = c(Estimate, `Std. Error (OLS)`, `p value (OLS)`,
                `Std. Error (HC3)`, `p value (HC3)`),
    decimals = 3
  ) %>%
  

  tab_style(
    style = cell_text(color = "red"),
    locations = cells_body(columns = c(`p value (OLS)`, `p value (HC3)`))
  ) %>%
  

  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Term)
  )


```
